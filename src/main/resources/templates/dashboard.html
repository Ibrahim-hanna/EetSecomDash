<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord projet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body, html {
            height: auto !important;
            min-height: 0 !important;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .topbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 200;
            background: #f6f8fb;
            padding: 24px 0 16px 0;
            text-align: center;
            font-size: 1.6rem;
            font-weight: 600;
            color: #222;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 0;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh !important;
            min-height: 100vh !important;
            z-index: 100;
            background: linear-gradient(180deg, #3ec6e0 0%, #1e90c2 100%);
            color: #fff;
            display: flex;
            flex-direction: column;
        }
        .sidebar .logo {
            font-weight: bold;
            font-size: 1.5rem;
            letter-spacing: 2px;
            padding: 32px 0 24px 0;
            text-align: center;
        }
        .sidebar .nav-link {
            color: #fff;
            font-size: 1.1rem;
            padding: 14px 32px;
            border-radius: 0 20px 20px 0;
            margin-bottom: 4px;
            transition: background 0.2s;
        }
        .sidebar .nav-link.active, .sidebar .nav-link:hover {
            background: rgba(255,255,255,0.18);
            color: #fff;
            font-weight: 600;
        }
        .main-content {
            margin-left: 260px !important;
            padding: 32px 32px 24px 32px;
            background: #f6f8fb;
            min-height: 100vh;
            margin-top: 0 !important;
            display: block;
            padding-top: 0 !important;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
            animation: fadeIn 0.4s;
            margin-top: 0 !important;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: none; }
        }
        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 24px;
            color: #3a86ff;
        }
        .info-list .bi {
            color: #36cfc9;
            margin-right: 8px;
        }
        .card-synthese, .section .card, .section .list-group {
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(58,134,255,0.08);
            margin-bottom: 24px;
        }
        @media (max-width: 900px) {
            .sidebar { width: 100vw; min-height: auto; position: static; top: 0; }
            .main-content { margin-left: 0 !important; padding: 8px; margin-top: 70px !important; }
        }
        .main-content {
            display: block;
        }
        .badge-green {
            background-color: #28a745;
            color: #fff;
        }
        .badge-yellow {
            background-color: #ffc107;
            color: #222;
        }
        #section-info .card-synthese,
        #section-suivi .card-synthese {
            margin-left: auto;
            margin-right: auto;
            float: none;
            margin-top: 0;
        }
        #section-suivi .card-synthese .card-body,
        #section-info .card-synthese .card-body {
            padding-top: 12px;
            padding-bottom: 24px;
        }
        #section-suivi .card-title,
        #section-info .card-title {
            margin-top: 0;
            margin-bottom: 18px;
        }
        #section-suivi .card-synthese,
        #section-info .card-synthese {
            margin-top: 0;
        }
        .main-content {
            padding-top: 8px !important;
        }
        .modal-dialog {
            display: flex;
            align-items: flex-start;
            min-height: calc(100vh - 1rem);
            margin: 0 auto;
            margin-top: 32px !important;
        }
        .modal.fade .modal-dialog {
            transform: none !important;
        }
        @media (max-width: 900px) {
            .modal-dialog {
                margin-top: 12px !important;
            }
        }
        .modal {
            align-items: flex-start !important;
            justify-content: center !important;
            z-index: 1050 !important;
        }
        .modal-dialog {
            margin-top: 32px !important;
        }
        @media (max-width: 900px) {
            .modal-dialog {
                margin-top: 12px !important;
            }
        }
        .modal-backdrop {
            z-index: 1040 !important;
        }
        .main-header {
            padding-left: 0 !important;
        }
        .main-content > .d-flex {
            padding-left: 0 !important;
            margin-left: 0 !important;
        }
        
        /* Styles pour le tableau de bord global */
        .card.bg-primary, .card.bg-success, .card.bg-info, .card.bg-warning, .card.bg-danger, .card.bg-secondary {
            transition: transform 0.2s ease-in-out;
        }
        
        .card.bg-primary:hover, .card.bg-success:hover, .card.bg-info:hover, .card.bg-warning:hover, .card.bg-danger:hover, .card.bg-secondary:hover {
            transform: translateY(-5px);
        }
        
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }
        
        .progress {
            border-radius: 10px;
        }
        
        .progress-bar {
            font-size: 12px;
            font-weight: bold;
        }
        
        /* Styles pour le tableau avec plus de colonnes */
        .table-responsive {
            font-size: 0.9rem;
        }
        
        .table th {
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .table td {
            vertical-align: middle;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .table td:hover {
            white-space: normal;
            word-wrap: break-word;
        }
    </style>
</head>
<body>

<div class="d-flex align-items-center justify-content-between px-4" style="margin-left: 260px; margin-top: 24px;">
  <div class="flex-grow-1 text-center">
    <span class="fw-bold fs-4">Bienvenue MR/MME <span th:text="${userName}">Utilisateur</span></span>
  </div>
  <div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="profileMenu" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-person-circle"></i> Profil
    </button>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileMenu">
      <li><span class="dropdown-item-text"><b th:text="${userRole}">Rôle</b></span></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item" href="/logout">Se déconnecter</a></li>
    </ul>
  </div>
</div>

<div class="d-flex align-items-center justify-content-between px-4 py-3" style="margin-left: 260px; margin-top: 0;">
  <form method="get" action="/dashboard" class="d-flex align-items-center gap-2 mb-0">
      <label for="projetSelect" class="form-label mb-0"><i class="bi bi-folder2-open"></i> Projet :</label>
      <select id="projetSelect" name="projet" class="form-select w-auto">
          <th:block th:each="p, i : ${projets}">
            <option th:value="${i.index}" th:selected="${i.index} == ${selectedProjetIndex}" th:text="${p.numeroProjet} + ' - ' + ${p.client}"></option>
          </th:block>
      </select>
  </form>
  <div class="d-flex align-items-center gap-2" id="actionsProjet">
    <button type="button" class="btn btn-success" id="btnAddProjet"><i class="bi bi-plus-circle"></i> Ajouter</button>
    <button type="button" class="btn btn-warning" id="btnEditProjet"><i class="bi bi-pencil"></i> Modifier</button>
    <button type="button" class="btn btn-danger" id="btnDeleteProjet"><i class="bi bi-trash"></i> Supprimer</button>
  </div>
</div>
<!-- Correction de l'alignement du contenu principal à droite de la sidebar -->
<div class="d-flex" style="min-height: 100vh;">
  <div class="sidebar d-flex flex-column" style="height: 100vh;">
    <!-- Sidebar logo -->
    <div class="sidebar-logo text-center mb-4" style="margin-top: 32px;">
        <img src="/images/edet_logo.png" alt="EDET Logo" style="max-width: 120px; max-height: 80px;" />
    </div>
    <ul class="nav flex-column mb-auto">
        <li class="nav-item"><a class="nav-link active" href="#" onclick="showSection('info', event)"><i class="bi bi-info-circle"></i> Informations projet</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('suivi', event)"><i class="bi bi-graph-up"></i> Suivi d'exécution</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('detail', event)"><i class="bi bi-list-check"></i> Suivi détaillé</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('reception', event)"><i class="bi bi-file-earmark-arrow-down"></i> Réception (PJ)</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('synthese', event)"><i class="bi bi-bar-chart"></i> Synthèse</a></li>
    </ul>
    <div class="mt-auto p-3 small text-center opacity-75">&copy; 2025 Projet</div>
</div>
<div class="flex-grow-1 main-content" style="padding-top:0; margin-top:0;">
    <!-- Informations projet -->
    <div id="section-info" class="section active" style="display:block !important; visibility:visible !important;"></div>
    <!-- Suivi d'exécution dynamique -->
    <div id="section-suivi" class="section" style="display:none;"></div>
    <!-- Suivi détaillé dynamique -->
    <div id="section-detail" class="section"></div>
    <!-- Réception (Pièces jointes) -->
    <div id="section-reception" class="section"></div>
    <!-- Synthèse dynamique -->
    <div id="section-synthese" class="section"></div>
</div>

<!-- Modal Ajout Pièce Jointe -->
<div class="modal fade" id="pieceJointeModal" tabindex="-1" aria-labelledby="pieceJointeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pieceJointeModalLabel">Ajouter une pièce jointe</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="pieceJointeForm" enctype="multipart/form-data">
          <input type="hidden" id="pieceJointeProjetId">
          <div class="mb-3">
            <label for="typePieceJointe" class="form-label">Type de pièce jointe</label>
            <select class="form-select" id="typePieceJointe">
              <option value="">Sélectionner un type</option>
              <option value="pvReceptionProvisoire">PV de réception provisoire</option>
              <option value="pvReceptionDefinitif">PV de réception définitif</option>
              <option value="attestationReference">Attestation de référence</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="fichierPieceJointe" class="form-label">Fichier</label>
            <input type="file" class="form-control" id="fichierPieceJointe" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
            <div class="form-text">Formats acceptés : PDF, DOC, DOCX, JPG, PNG</div>
          </div>
          <div class="mb-3">
            <label for="descriptionPieceJointe" class="form-label">Description (optionnel)</label>
            <textarea class="form-control" id="descriptionPieceJointe" rows="3" placeholder="Description de la pièce jointe..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" id="btnSavePieceJointe">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Ajout/Modification Projet -->
<div class="modal fade" id="projetModal" tabindex="-1" aria-labelledby="projetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="projetModalLabel">Ajouter/Modifier un projet</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="projetForm">
          <input type="hidden" id="projetId">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="numeroProjet" class="form-label">N° Projet/Contrat</label>
                <input type="text" class="form-control" id="numeroProjet">
              </div>
              <div class="mb-3">
                <label for="client" class="form-label">Client</label>
                <input type="text" class="form-control" id="client">
              </div>
              <div class="mb-3">
                <label for="designation" class="form-label">Désignation</label>
                <textarea class="form-control" id="designation" rows="3"></textarea>
              </div>
              <div class="mb-3">
                <label for="typeProjet" class="form-label">Type de projet</label>
                <select class="form-select" id="typeProjet">
                  <option value="">Sélectionner un type</option>
                  <option value="Détection incendie">Détection incendie</option>
                  <option value="Protection incendie">Protection incendie</option>
                  <option value="Vidéosurveillance">Vidéosurveillance</option>
                  <option value="Contrôle d'accès">Contrôle d'accès</option>
                  <option value="Asservissement">Asservissement</option>
                  <option value="GTC">GTC</option>
                  <option value="Sonorisation">Sonorisation</option>
                  <option value="Affichage">Affichage</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="responsableInterne" class="form-label">Responsable interne</label>
                <input type="text" class="form-control" id="responsableInterne">
              </div>
              <div class="mb-3">
                <label for="responsableExterne" class="form-label">Responsable externe</label>
                <input type="text" class="form-control" id="responsableExterne">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="dureeContractuelle" class="form-label">Durée contractuelle</label>
                <input type="text" class="form-control" id="dureeContractuelle">
              </div>
              <div class="mb-3">
                <label for="montantContratTTC" class="form-label">Montant contrat TTC</label>
                <input type="number" class="form-control" id="montantContratTTC" step="0.01">
              </div>
              <div class="mb-3">
                <label for="montantAvenant" class="form-label">Montant avenant</label>
                <input type="number" class="form-control" id="montantAvenant" step="0.01">
              </div>
              <div class="mb-3">
                <label for="dateDebut" class="form-label">Date de début</label>
                <input type="date" class="form-control" id="dateDebut">
              </div>
              <div class="mb-3">
                <label for="dateFinEffective" class="form-label">Date de fin effective</label>
                <input type="date" class="form-control" id="dateFinEffective">
              </div>
              <div class="mb-3">
                <label for="pourcentageAvancement" class="form-label">% Avancement</label>
                <input type="number" class="form-control" id="pourcentageAvancement" min="0" max="100">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="statutExecution" class="form-label">Statut d'exécution</label>
                <select class="form-select" id="statutExecution">
                  <option value="">Sélectionner un statut</option>
                  <option value="Terminé">Terminé</option>
                  <option value="Non démarré">Non démarré</option>
                  <option value="En cours">En cours</option>
                  <option value="Annulé">Annulé</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="montantCumul" class="form-label">Montant cumulé</label>
                <input type="number" class="form-control" id="montantCumul" step="0.01">
              </div>
              <div class="mb-3">
                <label for="montantEncaisse" class="form-label">Montant encaissé</label>
                <input type="number" class="form-control" id="montantEncaisse" step="0.01">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="soldeRestant" class="form-label">Solde restant</label>
                <input type="number" class="form-control" id="soldeRestant" step="0.01">
              </div>
              <div class="mb-3">
                <label for="statutFacturation" class="form-label">Statut de facturation</label>
                <select class="form-select" id="statutFacturation">
                  <option value="">Sélectionner un statut</option>
                  <option value="Non payé">Non payé</option>
                  <option value="Partiellement payé">Partiellement payé</option>
                  <option value="Payé avec retenue 7%">Payé avec retenue 7%</option>
                  <option value="Payé avec retenue 10%">Payé avec retenue 10%</option>
                  <option value="Payé avec retenue 20%">Payé avec retenue 20%</option>
                  <option value="Totalement payé">Totalement payé</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="remarques" class="form-label">Remarques</label>
                <textarea class="form-control" id="remarques" rows="3"></textarea>
              </div>
            </div>
          </div>
          
          <!-- Nouvelle section pour le suivi d'exécution détaillé -->
          <div class="row mt-4">
            <div class="col-12">
              <h6 class="text-primary mb-3"><i class="bi bi-graph-up"></i> Suivi d'exécution détaillé</h6>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="phase" class="form-label"><i class="bi bi-flag"></i> Phase</label>
                <input type="text" class="form-control" id="phase" placeholder="Ex: Phase 1, Phase 2, etc.">
              </div>
              <div class="mb-3">
                <label for="zone" class="form-label"><i class="bi bi-geo-alt"></i> Zone</label>
                <input type="text" class="form-control" id="zone" placeholder="Zone d'intervention">
              </div>
              <div class="mb-3">
                <label for="quantiteInstallee" class="form-label"><i class="bi bi-boxes"></i> Quantité installée</label>
                <input type="text" class="form-control" id="quantiteInstallee" placeholder="Ex: 50 détecteurs">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="remarquesExecution" class="form-label"><i class="bi bi-chat-text"></i> Remarques exécution</label>
                <textarea class="form-control" id="remarquesExecution" rows="3" placeholder="Remarques sur l'exécution..."></textarea>
              </div>
            </div>
          </div>
          
          <!-- Nouvelle section pour le suivi règlement détaillé -->
          <div class="row mt-4">
            <div class="col-12">
              <h6 class="text-primary mb-3"><i class="bi bi-cash-stack"></i> Suivi règlement détaillé</h6>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="nAttachment" class="form-label"><i class="bi bi-hash"></i> N° Attachment</label>
                <input type="text" class="form-control" id="nAttachment" placeholder="Numéro d'attachment">
              </div>
              <div class="mb-3">
                <label for="dateAttachement" class="form-label"><i class="bi bi-calendar-plus"></i> Date attachement</label>
                <input type="date" class="form-control" id="dateAttachement">
              </div>
              <div class="mb-3">
                <label for="dateFacture" class="form-label"><i class="bi bi-calendar-event"></i> Date facture</label>
                <input type="date" class="form-control" id="dateFacture">
              </div>
              <div class="mb-3">
                <label for="datePaiement" class="form-label"><i class="bi bi-calendar-check"></i> Date paiement</label>
                <input type="date" class="form-control" id="datePaiement">
              </div>
              <div class="mb-3">
                <label for="modeReglement" class="form-label"><i class="bi bi-credit-card"></i> Mode de règlement</label>
                <select class="form-select" id="modeReglement">
                  <option value="">Sélectionner un mode</option>
                  <option value="Virement">Virement</option>
                  <option value="Chèque">Chèque</option>
                  <option value="Espèce">Espèce</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="solde" class="form-label"><i class="bi bi-calculator"></i> Solde</label>
                <input type="number" class="form-control" id="solde" step="0.01" placeholder="Solde">
              </div>
              <div class="mb-3">
                <label for="remarqueReglement" class="form-label"><i class="bi bi-chat-text"></i> Remarque règlement</label>
                <textarea class="form-control" id="remarqueReglement" rows="3" placeholder="Remarques sur le règlement..."></textarea>
              </div>
            </div>
          </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-primary" form="projetForm">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script th:inline="javascript">
console.log('=== JS PRINCIPAL CHARGE ET EXECUTE ===');
console.log('JS chargé !');
console.log('DOM ready, initialisation des gestionnaires d\'événements...');
function updateSynthese(projet) {
    // Fonction pour mettre à jour la synthèse du projet
    // Cette fonction peut être étendue selon les besoins
    console.log('updateSynthese appelée avec:', projet);
}

// Fonction de validation du formulaire de projet
function validateProjetForm() {
    console.log('Validation du formulaire de projet...');
    const numeroProjet = document.getElementById('numeroProjet').value;
    const client = document.getElementById('client').value;
    const designation = document.getElementById('designation').value;
    
    if (!numeroProjet || !numeroProjet.trim()) {
        showAlert('Le numéro de projet est obligatoire', 'warning');
        return false;
    }
    
    if (!client || !client.trim()) {
        showAlert('Le client est obligatoire', 'warning');
        return false;
    }
    
    if (!designation || !designation.trim()) {
        showAlert('La désignation est obligatoire', 'warning');
        return false;
    }
    
    console.log('Validation OK');
    return true;
}
const userRole = /*[[${userRole}]]*/ 'ADMIN';
let projets = /*[[${projets}]]*/ [];
console.log('projets:', projets);
let selectedProjetIndex = -1; // Ne pas initialiser automatiquement
let selectedProjet = null; // Variable globale pour le projet sélectionné
let stompClient = null;

function renderProjetSelector() {
    const select = document.getElementById('projetSelect');
    select.innerHTML = '';
    projets.forEach((p, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = p.numeroProjet || p.numero_projet || p["N° Projet/CONTRAT"] || 'Projet';
        if (i === selectedProjetIndex) opt.selected = true;
        select.appendChild(opt);
    });
    // Correction : si aucun projet sélectionné, sélectionner le premier
    if (projets.length > 0 && (selectedProjetIndex === -1 || selectedProjetIndex >= projets.length)) {
        selectedProjetIndex = 0;
    }
    // Correction : afficher le contenu si projets non vide
    const mainContent = document.querySelector('.flex-grow-1');
    if (mainContent) {
        if (projets.length > 0) {
            mainContent.style.visibility = 'visible';
        } else {
            mainContent.style.visibility = 'visible';
            mainContent.innerHTML = '<div class="alert alert-warning mt-5">Aucun projet disponible.</div>';
        }
    }
}

function renderSections() {
    console.log('renderSections called');
    const p = projets[selectedProjetIndex] || {};
    selectedProjet = p; // Mettre à jour selectedProjet
    console.log('Rendu des sections pour le projet:', p);
    // Mise à jour des informations du projet
    updateProjectInfo(p);
    // Mise à jour de la synthèse
    updateSynthese(p);
    // Afficher la section active par défaut si aucune n'est active
    const activeSection = document.querySelector('.section.active');
    if (!activeSection) {
        showSection('info', null);
    }
    // Forcer l'affichage de la section info si elle est active
    const infoSection = document.getElementById('section-info');
    if (infoSection && infoSection.classList.contains('active')) {
        infoSection.style.display = 'block';
        infoSection.style.visibility = 'visible';
    }
}

function updateProjectInfo(projet) {
    const infoSection = document.getElementById('section-info');
    if (!infoSection) return;
    if (!projet) {
        infoSection.innerHTML = '<div class="alert alert-danger">Aucun projet sélectionné</div>';
        return;
    }
    
    // Bouton pour ADMIN/SUPERVISEUR
    let btnAdd = '';
    if (userRole === 'ADMIN' || userRole === 'SUPERVISEUR') {
        btnAdd = `<button type="button" class="btn btn-primary btn-sm mb-3" id="btnAddPieceJointeInfo">
            <i class="bi bi-plus-circle"></i> Ajouter un contrat
        </button>`;
    }
    
    function val(label, icon, value) {
        return `<li class='list-group-item d-flex align-items-center'>
            <i class='bi ${icon} me-2 text-info'></i>
            <span class='fw-bold'>${label} :</span> <span class='ms-2 ${value ? "" : "text-secondary"}'>${value || "Non renseigné"}</span>
        </li>`;
    }
    
    infoSection.innerHTML = `
        <div class="section-title d-flex justify-content-between align-items-center">
            <span><i class="bi bi-info-circle"></i> Informations du projet</span>
            ${btnAdd}
        </div>
        <div class="card card-synthese mb-4" style="max-width:900px;width:100%;">
            <div class="card-body">
                <h3 class="card-title mb-4 text-primary"><i class="bi bi-info-circle"></i> Informations du projet</h3>
                <ul class="list-group list-group-flush">
                    ${val('Client', 'bi-person-badge', projet.client)}
                    ${val('N° Projet / Contrat', 'bi-hash', projet.numeroProjet)}
                    ${val('Désignation', 'bi-card-text', projet.designation)}
                    ${val('Type de projet', 'bi-tags', projet.typeProjet)}
                    ${val('Responsable interne', 'bi-person', projet.responsableInterne)}
                    ${val('Responsable externe', 'bi-person', projet.responsableExterne)}
                    ${val('Durée contractuelle', 'bi-clock-history', projet.dureeContractuelle)}
                    ${val('Montant total TTC', 'bi-cash-coin', projet.montantContratTTC)}
                    ${val('Montant avenant', 'bi-plus-circle', projet.montantAvenant)}
                </ul>
                <hr>
                <h6 class="card-title mb-3"><i class="bi bi-file-earmark-text"></i> Contrat</h6>
                <div class="list-group list-group-flush">
                    <div class="list-group-item">
                        <i class="bi bi-paperclip"></i> Pièce jointe :
                        ${(projet.piecesJointes && projet.piecesJointes.contrat && projet.piecesJointes.contrat.nomFichier)
                          ? (() => {
                              const obj = projet.piecesJointes.contrat;
                              const nom = obj.nomFichier;
                              const isPdf = nom && nom.toLowerCase().endsWith('.pdf');
                              const url = isPdf
                                ? `/api/pieces-jointes/preview/${nom}`
                                : `/api/pieces-jointes/files/${nom}`;
                              return `<a href="${url}" target="_blank">
                                        <img src="${url}" style="max-width:100px;max-height:100px;"/>
                                        <span style="margin-left:8px;">${nom}</span>
                                        ${obj.description ? `<div class='text-muted small'>${obj.description}</div>` : ''}
                                      </a>
                                      <div class='mt-2' ${userRole === 'EMPLOYE' ? 'style=\"display: none;\"' : ''}>
                                        <button type='button' class='btn btn-sm btn-outline-primary me-1' onclick=\"modifierPieceJointe('contrat')\">✏️ Modifier</button>
                                        <button type='button' class='btn btn-sm btn-outline-danger' onclick=\"supprimerPieceJointe('contrat')\">❌ Supprimer</button>
                                      </div>`;
                            })()
                          : '<span class="text-muted">Aucun fichier</span>'}
                    </div>
                </div>
            </div>
        </div>
    `;

    // Gestion du clic sur le bouton (après injection)
    setTimeout(() => {
      const btn = document.getElementById('btnAddPieceJointeInfo');
      if (btn && (userRole === 'ADMIN' || userRole === 'SUPERVISEUR')) {
        btn.onclick = function() {
          const projet = projets[selectedProjetIndex];
          if (!projet || !projet.id) {
            showAlert('Aucun projet sélectionné', 'danger');
            return;
          }
          document.getElementById('pieceJointeProjetId').value = projet.id;
          document.getElementById('pieceJointeForm').reset();
          // Limite les options du select pour Informations projet
          const select = document.getElementById('typePieceJointe');
          select.innerHTML = `
            <option value="">Sélectionner un type</option>
            <option value="contrat">Contrat</option>
          `;
          const modal = new bootstrap.Modal(document.getElementById('pieceJointeModal'));
          modal.show();
          setTimeout(attachSavePieceJointeHandler, 0);
        };
      }
    }, 0);
}

function updateSuiviExecution(projet) {
    const suiviSection = document.getElementById('section-suivi');
    if (!suiviSection) return;
    if (!projet) {
        suiviSection.innerHTML = '<div class="alert alert-danger">Aucun projet sélectionné</div>';
        return;
    }
    suiviSection.innerHTML = `
      <div class="section-title"><i class="bi bi-graph-up"></i> Suivi d'exécution</div>
      <div class="card card-synthese mb-4" style="max-width:900px;width:100%;">
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item"><b>Date début :</b> ${projet.dateDebut || 'Non défini'}</li>
            <li class="list-group-item"><b>Date fin effective :</b> ${projet.dateFinEffective || 'Non défini'}</li>
            <li class="list-group-item"><b>% d'avancement :</b> ${projet.avancement || '0%'}</li>
            <li class="list-group-item"><b>Statut d'exécution :</b> ${projet.statutExecution || 'Non défini'}</li>
            <li class="list-group-item"><b>Montant cumulé :</b> ${projet.montantCumul || '0'}</li>
            <li class="list-group-item"><b>Montant encaissé :</b> ${projet.montantEncaisse || '0'}</li>
            <li class="list-group-item"><b>Solde restant :</b> ${projet.soldeRestant || '0'}</li>
            <li class="list-group-item"><b>Statut de facturation :</b> ${projet.statutFacturation || 'Non défini'}</li>
          </ul>
        </div>
      </div>
    `;
}

function updateSuiviDetaille(projet) {
    const detailSection = document.getElementById('section-detail');
    if (!detailSection) return;
    if (!projet) {
        detailSection.innerHTML = '<div class="alert alert-danger">Aucun projet sélectionné</div>';
        return;
    }
    // Bouton pour ADMIN/SUPERVISEUR
    let btnAdd = '';
    if (userRole === 'ADMIN' || userRole === 'SUPERVISEUR') {
        btnAdd = `<button type="button" class="btn btn-primary btn-sm mb-3" id="btnAddPieceJointeDetail">
            <i class="bi bi-plus-circle"></i> Ajouter une pièce jointe
        </button>`;
    }
    detailSection.innerHTML = `
      <div class="section-title d-flex justify-content-between align-items-center">
        <span><i class="bi bi-list-check"></i> Suivi détaillé</span>
        ${btnAdd}
      </div>
      <div class="row">
        <div class="col-md-6">
          <div class="card card-synthese mb-3">
            <h6><i class="bi bi-graph-up"></i> Suivi exécution détaillée</h6>
            <ul class="list-group list-group-flush">
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-flag"></i> Phase</span>
                <span class="badge bg-primary">${projet.phase || 'Non définie'}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-check-circle"></i> État</span>
                <span class="badge bg-info">${projet.statutExecution || 'Non défini'}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-calendar-event"></i> Date de démarrage</span>
                <span>${projet.dateDebut || 'Non définie'}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-geo-alt"></i> Zone</span>
                <span>${projet.zone || 'Non définie'}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-boxes"></i> Quantité installée</span>
                <span>${projet.quantiteInstallee || 'Non définie'}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-percent"></i> Avancement</span>
                <span class="badge bg-success">${projet.avancement || '0%'}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-chat-text"></i> Remarques exécution</span>
                <span>${projet.remarquesExecution || 'Aucune remarque'}</span>
              </li>
              <li class="list-group-item">
                <i class="bi bi-paperclip"></i> Pièce jointe :
                ${(projet.piecesJointes && projet.piecesJointes.suiviExecutionDetaille && projet.piecesJointes.suiviExecutionDetaille.nomFichier)
                  ? (() => {
                      const obj = projet.piecesJointes.suiviExecutionDetaille;
                      const nom = obj && obj.nomFichier ? obj.nomFichier : '';
                      const isPdf = nom && nom.toLowerCase().endsWith('.pdf');
                      const url = isPdf
                        ? `/api/pieces-jointes/preview/${nom}`
                        : `/api/pieces-jointes/files/${nom}`;
                      return `<a href="${url}" target="_blank">
                                <img src="${url}" style="max-width:100px;max-height:100px;"/>
                                <span style="margin-left:8px;">${nom}</span>
                                ${obj.description ? `<div class='text-muted small'>${obj.description}</div>` : ''}
                              </a>
                              <div class='mt-2' ${userRole === 'EMPLOYE' ? 'style=\"display: none;\"' : ''}>
                                <button type='button' class='btn btn-sm btn-outline-primary me-1' onclick=\"modifierPieceJointe('suivi_execution_detaille')\">✏️ Modifier</button>
                                <button type='button' class='btn btn-sm btn-outline-danger' onclick=\"supprimerPieceJointe('suivi_execution_detaille')\">❌ Supprimer</button>
                              </div>`;
                    })()
                  : '<span class="text-muted">Aucun fichier</span>'}
              </li>
            </ul>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card card-synthese mb-3">
            <h6><i class="bi bi-cash-stack"></i> Suivi règlement détaillé</h6>
            <ul class="list-group list-group-flush">
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-hash"></i> N° Attachment</span>
                <span class="badge bg-primary">${projet.nAttachment || 'Non défini'}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-currency-euro"></i> Montant TTC</span>
                <span class="badge bg-info">${projet.montantContratTTC || 'Non défini'}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-calendar-plus"></i> Date attachement</span>
                <span>${projet.dateAttachement || 'Non défini'}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-receipt"></i> Statut facture</span>
                <span class="badge bg-secondary">${projet.statutFacturation || 'Non défini'}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-calendar-event"></i> Date facture</span>
                <span>${projet.dateFacture || 'Non défini'}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-calendar-check"></i> Date paiement</span>
                <span>${projet.datePaiement || 'Non défini'}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-cash"></i> Montant encaissé</span>
                <span class="badge bg-success">${projet.montantEncaisse || 'Non défini'}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-credit-card"></i> Mode de règlement</span>
                <span>${projet.modeReglement || 'Non défini'}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-calculator"></i> Solde</span>
                <span>${projet.solde || 'Non défini'}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span><i class="bi bi-chat-text"></i> Remarque règlement</span>
                <span>${projet.remarqueReglement || 'Non défini'}</span>
              </li>
              <li class="list-group-item">
                <i class="bi bi-paperclip"></i> Pièce jointe :
                ${(projet.piecesJointes && projet.piecesJointes.suiviReglementDetaille && projet.piecesJointes.suiviReglementDetaille.nomFichier)
                  ? (() => {
                      const obj = projet.piecesJointes.suiviReglementDetaille;
                      const nom = obj && obj.nomFichier ? obj.nomFichier : '';
                      const isPdf = nom && nom.toLowerCase().endsWith('.pdf');
                      const url = isPdf
                        ? `/api/pieces-jointes/preview/${nom}`
                        : `/api/pieces-jointes/files/${nom}`;
                      return `<a href="${url}" target="_blank">
                                <img src="${url}" style="max-width:100px;max-height:100px;"/>
                                <span style="margin-left:8px;">${nom}</span>
                                ${(obj && obj.description) ? `<div class='text-muted small'>${obj.description}</div>` : ''}
                              </a>
                              <div class='mt-2' ${userRole === 'EMPLOYE' ? 'style=\"display: none;\"' : ''}>
                                <button type='button' class='btn btn-sm btn-outline-primary me-1' onclick=\"modifierPieceJointe('suivi_reglement_detaille')\">✏️ Modifier</button>
                                <button type='button' class='btn btn-sm btn-outline-danger' onclick=\"supprimerPieceJointe('suivi_reglement_detaille')\">❌ Supprimer</button>
                              </div>`;
                    })()
                  : '<span class="text-muted">Aucun fichier</span>'}
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="card card-synthese">
        <h6><i class="bi bi-chat-text"></i> Remarques et observations</h6>
        <p>${projet.remarques || 'Aucune remarque pour l\'instant.'}</p>
      </div>
    `;

    // Gestion du clic sur le bouton (après injection)
    setTimeout(() => {
      const btn = document.getElementById('btnAddPieceJointeDetail');
      if (btn && (userRole === 'ADMIN' || userRole === 'SUPERVISEUR')) {
        btn.style.display = 'inline-block';
        btn.onclick = function() {
          const projet = projets[selectedProjetIndex];
          if (!projet || !projet.id) {
            showAlert('Aucun projet sélectionné', 'danger');
            return;
          }
          document.getElementById('pieceJointeProjetId').value = projet.id;
          document.getElementById('pieceJointeForm').reset();
          // Limite les options du select pour Suivi détaillé
          const select = document.getElementById('typePieceJointe');
          select.innerHTML = `
            <option value="">Sélectionner un type</option>
            <option value="suivi_execution_detaille">Suivi exécution détaillée</option>
            <option value="suivi_reglement_detaille">Suivi règlement détaillé</option>
          `;
          const modal = new bootstrap.Modal(document.getElementById('pieceJointeModal'));
          modal.show();
          setTimeout(attachSavePieceJointeHandler, 0);
        };
      }
    }, 0);
}

function updateReceptionSection(projet) {
    const receptionSection = document.getElementById('section-reception');
    if (!receptionSection) return;
    if (!projet) {
        receptionSection.innerHTML = '<div class="alert alert-danger">Aucun projet sélectionné</div>';
        return;
    }

    // Bouton pour ADMIN/SUPERVISEUR
    let btnAdd = '';
    if (userRole === 'ADMIN' || userRole === 'SUPERVISEUR') {
        btnAdd = `<button type="button" class="btn btn-primary btn-sm mb-3" id="btnAddPieceJointeReception">
            <i class="bi bi-plus-circle"></i> Ajouter une pièce jointe
        </button>`;
    }

    receptionSection.innerHTML = `
      <div class="section-title d-flex justify-content-between align-items-center">
        <span><i class="bi bi-file-earmark-arrow-down"></i> Réception (Pièces jointes)</span>
        ${btnAdd}
      </div>
      <div class="row">
        <div class="col-md-6">
          <div class="card card-synthese mb-3">
            <h6><i class="bi bi-file-earmark-check"></i> PV de réception provisoire</h6>
            <ul class="list-group list-group-flush">
              <li class="list-group-item">
                <i class="bi bi-paperclip"></i> Pièce jointe :
                ${(projet.piecesJointes && projet.piecesJointes.pvReceptionProvisoire && projet.piecesJointes.pvReceptionProvisoire.nomFichier)
                  ? (() => {
                      const obj = projet.piecesJointes.pvReceptionProvisoire;
                      const nom = obj.nomFichier;
                      const isPdf = nom && nom.toLowerCase().endsWith('.pdf');
                      const url = isPdf
                        ? `/api/pieces-jointes/preview/${nom}`
                        : `/api/pieces-jointes/files/${nom}`;
                      return `<a href="${url}" target="_blank">
                                <img src="${url}" style="max-width:100px;max-height:100px;"/>
                                <span style="margin-left:8px;">${nom}</span>
                                ${obj.description ? `<div class='text-muted small'>${obj.description}</div>` : ''}
                              </a>
                              <div class='mt-2' ${userRole === 'EMPLOYE' ? 'style=\"display: none;\"' : ''}>
                                <button type='button' class='btn btn-sm btn-outline-primary me-1' onclick=\"modifierPieceJointe('pvReceptionProvisoire')\">✏️ Modifier</button>
                                <button type='button' class='btn btn-sm btn-outline-danger' onclick=\"supprimerPieceJointe('pvReceptionProvisoire')\">❌ Supprimer</button>
                              </div>`;
                    })()
                  : '<span class="text-muted">Aucun fichier</span>'}
              </li>
            </ul>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card card-synthese mb-3">
            <h6><i class="bi bi-file-earmark-check-fill"></i> PV de réception définitif</h6>
            <ul class="list-group list-group-flush">
              <li class="list-group-item">
                <i class="bi bi-paperclip"></i> Pièce jointe :
                ${(projet.piecesJointes && projet.piecesJointes.pvReceptionDefinitive && projet.piecesJointes.pvReceptionDefinitive.nomFichier)
                  ? (() => {
                      const obj = projet.piecesJointes.pvReceptionDefinitive;
                      const nom = obj.nomFichier;
                      const isPdf = nom && nom.toLowerCase().endsWith('.pdf');
                      const url = isPdf
                        ? `/api/pieces-jointes/preview/${nom}`
                        : `/api/pieces-jointes/files/${nom}`;
                      return `<a href="${url}" target="_blank">
                                <img src="${url}" style="max-width:100px;max-height:100px;"/>
                                <span style="margin-left:8px;">${nom}</span>
                                ${obj.description ? `<div class='text-muted small'>${obj.description}</div>` : ''}
                              </a>
                              <div class='mt-2' ${userRole === 'EMPLOYE' ? 'style=\"display: none;\"' : ''}>
                                <button type='button' class='btn btn-sm btn-outline-primary me-1' onclick=\"modifierPieceJointe('pvReceptionDefinitive')\">✏️ Modifier</button>
                                <button type='button' class='btn btn-sm btn-outline-danger' onclick=\"supprimerPieceJointe('pvReceptionDefinitive')\">❌ Supprimer</button>
                              </div>`;
                    })()
                  : '<span class="text-muted">Aucun fichier</span>'}
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <div class="card card-synthese mb-3">
            <h6><i class="bi bi-award"></i> Attestation de référence</h6>
            <ul class="list-group list-group-flush">
              <li class="list-group-item">
                <i class="bi bi-paperclip"></i> Pièce jointe :
                ${(projet.piecesJointes && projet.piecesJointes.attestationReference && projet.piecesJointes.attestationReference.nomFichier)
                  ? (() => {
                      const obj = projet.piecesJointes.attestationReference;
                      const nom = obj.nomFichier;
                      const isPdf = nom && nom.toLowerCase().endsWith('.pdf');
                      const url = isPdf
                        ? `/api/pieces-jointes/preview/${nom}`
                        : `/api/pieces-jointes/files/${nom}`;
                      return `<a href="${url}" target="_blank">
                                <img src="${url}" style="max-width:100px;max-height:100px;"/>
                                <span style="margin-left:8px;">${nom}</span>
                                ${obj.description ? `<div class='text-muted small'>${obj.description}</div>` : ''}
                              </a>
                              <div class='mt-2' ${userRole === 'EMPLOYE' ? 'style=\"display: none;\"' : ''}>
                                <button type='button' class='btn btn-sm btn-outline-primary me-1' onclick=\"modifierPieceJointe('attestationReference')\">✏️ Modifier</button>
                                <button type='button' class='btn btn-sm btn-outline-danger' onclick=\"supprimerPieceJointe('attestationReference')\">❌ Supprimer</button>
                              </div>`;
                    })()
                  : '<span class="text-muted">Aucun fichier</span>'}
              </li>
            </ul>
          </div>
        </div>
      </div>
    `;

    // Gestion du clic sur le bouton (après injection)
    setTimeout(() => {
      const btn = document.getElementById('btnAddPieceJointeReception');
      if (btn && (userRole === 'ADMIN' || userRole === 'SUPERVISEUR')) {
        btn.onclick = function() {
          const projet = projets[selectedProjetIndex];
          if (!projet || !projet.id) {
            showAlert('Aucun projet sélectionné', 'danger');
            return;
          }
          document.getElementById('pieceJointeProjetId').value = projet.id;
          document.getElementById('pieceJointeForm').reset();
          // Limite les options du select pour Réception
          const select = document.getElementById('typePieceJointe');
          select.innerHTML = `
            <option value="">Sélectionner un type</option>
            <option value="pvReceptionProvisoire">PV de réception provisoire</option>
            <option value="pvReceptionDefinitif">PV de réception définitif</option>
            <option value="attestationReference">Attestation de référence</option>
          `;
          const modal = new bootstrap.Modal(document.getElementById('pieceJointeModal'));
          modal.show();
          setTimeout(attachSavePieceJointeHandler, 0);
        };
      }
    }, 0);
}

function updateSyntheseSection(projet) {
    const syntheseSection = document.getElementById('section-synthese');
    if (!syntheseSection) return;
    
    // Charger d'abord la synthèse globale
    fetch('/api/projets/synthese')
        .then(res => res.json())
        .then(synthese => {
            // Créer le tableau de bord global
            syntheseSection.innerHTML = `
                <div class="section-title"><i class="bi bi-bar-chart"></i> Tableau de bord global</div>
                
                <!-- KPIs en haut -->
                <div class="row mb-4">
                    <div class="col-md-2">
                        <div class="card text-center bg-primary text-white">
                            <div class="card-body">
                                <i class="bi bi-folder2-open fs-1 mb-2"></i>
                                <h4 class="card-title">${synthese.projetsEnCours || 0}</h4>
                                <p class="card-text">Projets en cours</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center bg-success text-white">
                            <div class="card-body">
                                <i class="bi bi-graph-up fs-1 mb-2"></i>
                                <h4 class="card-title">${synthese.avancementMoyen || 0}%</h4>
                                <p class="card-text">Avancement moyen</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center bg-info text-white">
                            <div class="card-body">
                                <i class="bi bi-cash-stack fs-1 mb-2"></i>
                                <h4 class="card-title">${formatCurrency(synthese.totalContrats || 0)}</h4>
                                <p class="card-text">Total montant TTC</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center bg-warning text-dark">
                            <div class="card-body">
                                <i class="bi bi-cash-coin fs-1 mb-2"></i>
                                <h4 class="card-title">${formatCurrency(synthese.totalEncaisse || 0)}</h4>
                                <p class="card-text">Total montant encaissé</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center bg-danger text-white">
                            <div class="card-body">
                                <i class="bi bi-calculator fs-1 mb-2"></i>
                                <h4 class="card-title">${formatCurrency(synthese.soldeRestant || 0)}</h4>
                                <p class="card-text">Total solde restant</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center bg-secondary text-white">
                            <div class="card-body">
                                <i class="bi bi-file-earmark-check fs-1 mb-2"></i>
                                <h4 class="card-title">${synthese.pvReceptionDisponible || 0}</h4>
                                <p class="card-text">PV réception disponible</p>
                                <button class="btn btn-sm btn-outline-light mt-2" onclick="showPvReceptionDetails()">
                                    <i class="bi bi-eye"></i> Voir détails
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tableau de tous les projets -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-table"></i> Vue d'ensemble de tous les projets</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>N° Projet</th>
                                        <th>Client</th>
                                        <th>Désignation</th>
                                        <th>Type</th>
                                        <th>Responsable</th>
                                        <th>Avancement</th>
                                        <th>Statut Exécution</th>
                                        <th>Attachement TTC</th>
                                        <th>Paiement Reçu</th>
                                        <th>Solde Restant</th>
                                        <th>Dernière Mise à Jour</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="projetsTableBody">
                                    <!-- Les projets seront chargés ici -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // Charger et afficher tous les projets dans le tableau
            loadProjetsTable();
        })
        .catch(error => {
            console.error('Erreur lors du chargement de la synthèse:', error);
            syntheseSection.innerHTML = '<div class="alert alert-danger">Erreur lors du chargement du tableau de bord</div>';
        });
}

function loadProjetsTable() {
    fetch('/api/projets')
        .then(res => res.json())
        .then(projets => {
            const tbody = document.getElementById('projetsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = projets.map(projet => {
                const avancement = projet.avancement || projet["% Avancement"] || "0%";
                const avancementNum = parseInt(avancement);
                const progressClass = avancementNum >= 80 ? 'bg-success' : avancementNum >= 50 ? 'bg-warning' : 'bg-danger';
                
                const statutClass = (projet.statutExecution || '').toLowerCase().includes('terminé') ? 'bg-success' :
                                  (projet.statutExecution || '').toLowerCase().includes('en cours') ? 'bg-warning' :
                                  (projet.statutExecution || '').toLowerCase().includes('annulé') ? 'bg-danger' : 'bg-secondary';
                
                return `
                    <tr>
                        <td><strong>${projet.numeroProjet || projet.numero_projet || projet["N° Projet/CONTRAT"] || 'N/A'}</strong></td>
                        <td>${projet.client || 'N/A'}</td>
                        <td>${projet.designation || 'N/A'}</td>
                        <td>${projet.typeProjet || 'N/A'}</td>
                        <td>${projet.responsableInterne || 'N/A'}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar ${progressClass}" role="progressbar" 
                                     style="width: ${avancementNum}%" aria-valuenow="${avancementNum}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    ${avancement}
                                </div>
                            </div>
                        </td>
                        <td><span class="badge ${statutClass}">${projet.statutExecution || 'N/A'}</span></td>
                        <td>${formatCurrency(parseMontant(projet.montantCumul))}</td>
                        <td>${formatCurrency(parseMontant(projet.montantEncaisse))}</td>
                        <td>${formatCurrency(parseMontant(projet.soldeRestant))}</td>
                        <td>${formatDate(projet.dateFinEffective || projet.dateDebut || 'N/A')}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="selectProjetFromTable(${projets.indexOf(projet)})">
                                <i class="bi bi-eye"></i> Voir
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        })
        .catch(error => {
            console.error('Erreur lors du chargement des projets:', error);
            const tbody = document.getElementById('projetsTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-danger">Erreur lors du chargement des projets</td></tr>';
            }
        });
}

function selectProjetFromTable(index) {
    selectedProjetIndex = index;
    document.getElementById('projetSelect').value = index;
    showSection('info', null);
    // Mettre à jour l'onglet actif
    document.querySelectorAll('.sidebar .nav-link').forEach(link => link.classList.remove('active'));
    document.querySelector('.sidebar .nav-link[onclick*="info"]').classList.add('active');
}

function formatCurrency(amount) {
    if (isNaN(amount)) return '0 MAD';
    return new Intl.NumberFormat('fr-FR', { 
        style: 'currency', 
        currency: 'MAD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function parseMontant(montantString) {
    if (!montantString || montantString === 'N/A' || montantString.trim() === '') {
        return 0;
    }
    
    // Nettoyer la chaîne : enlever les espaces, remplacer les virgules par des points
    let cleaned = montantString.toString().trim();
    
    // Si c'est déjà un nombre, le retourner directement
    if (!isNaN(cleaned)) {
        return parseFloat(cleaned);
    }
    
    // Enlever tous les caractères non numériques sauf les virgules et points
    cleaned = cleaned.replace(/[^\d.,]/g, '');
    
    // Si la chaîne contient une virgule, c'est probablement un séparateur de milliers
    if (cleaned.includes(',')) {
        // Si c'est le format français (1,234.56), remplacer la virgule par rien
        if (cleaned.match(/^\d{1,3}(,\d{3})*(\.\d+)?$/)) {
            cleaned = cleaned.replace(/,/g, '');
        } else {
            // Sinon, remplacer la virgule par un point (format européen)
            cleaned = cleaned.replace(',', '.');
        }
    }
    
    const result = parseFloat(cleaned);
    return isNaN(result) ? 0 : result;
}

function formatDate(dateString) {
    if (!dateString || dateString === 'N/A') return 'N/A';
    
    try {
        // Si c'est déjà une date au format ISO
        if (dateString.includes('-')) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }
        
        // Si c'est au format américain (MM/DD/YYYY)
        if (dateString.includes('/')) {
            const parts = dateString.split('/');
            if (parts.length === 3) {
                const date = new Date(parts[2], parts[0] - 1, parts[1]);
                return date.toLocaleDateString('fr-FR');
            }
        }
        
        return dateString;
    } catch (error) {
        return dateString;
    }
}

function showPvReceptionDetails() {
    fetch('/api/projets')
        .then(res => res.json())
        .then(projets => {
            const projetsAvecPv = projets.filter(projet => {
                return projet.piecesJointes && 
                       ((projet.piecesJointes.pvReceptionProvisoire && projet.piecesJointes.pvReceptionProvisoire.nomFichier) ||
                        (projet.piecesJointes.pvReceptionDefinitive && projet.piecesJointes.pvReceptionDefinitive.nomFichier));
            });
            
            let detailsHtml = `
                <div class="modal fade" id="pvDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-file-earmark-check"></i> Détails des PV de réception disponibles
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p class="text-muted mb-3">${projetsAvecPv.length} projet(s) avec PV de réception disponible(s)</p>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>N° Projet</th>
                                                <th>Client</th>
                                                <th>PV Provisoire</th>
                                                <th>PV Définitif</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
            `;
            
            projetsAvecPv.forEach(projet => {
                const pvProvisoire = projet.piecesJointes.pvReceptionProvisoire && projet.piecesJointes.pvReceptionProvisoire.nomFichier;
                const pvDefinitif = projet.piecesJointes.pvReceptionDefinitive && projet.piecesJointes.pvReceptionDefinitive.nomFichier;
                
                detailsHtml += `
                    <tr>
                        <td><strong>${projet.numeroProjet || 'N/A'}</strong></td>
                        <td>${projet.client || 'N/A'}</td>
                        <td>
                            ${pvProvisoire ? 
                                `<span class="badge bg-success">✓ ${pvProvisoire}</span>` : 
                                `<span class="badge bg-secondary">Non disponible</span>`
                            }
                        </td>
                        <td>
                            ${pvDefinitif ? 
                                `<span class="badge bg-success">✓ ${pvDefinitif}</span>` : 
                                `<span class="badge bg-secondary">Non disponible</span>`
                            }
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="selectProjetFromPvDetails('${projet.numeroProjet}')">
                                <i class="bi bi-eye"></i> Voir projet
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            detailsHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Supprimer l'ancien modal s'il existe
            const oldModal = document.getElementById('pvDetailsModal');
            if (oldModal) {
                oldModal.remove();
            }
            
            // Ajouter le nouveau modal au body
            document.body.insertAdjacentHTML('beforeend', detailsHtml);
            
            // Afficher le modal
            const modal = new bootstrap.Modal(document.getElementById('pvDetailsModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Erreur lors du chargement des détails PV:', error);
            showAlert('Erreur lors du chargement des détails', 'danger');
        });
}

function selectProjetFromPvDetails(numeroProjet) {
    // Fermer le modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('pvDetailsModal'));
    if (modal) {
        modal.hide();
    }
    
    // Trouver l'index du projet dans la liste
    const projetIndex = projets.findIndex(p => p.numeroProjet === numeroProjet);
    if (projetIndex !== -1) {
        selectProjetFromTable(projetIndex);
    } else {
        showAlert('Projet non trouvé', 'warning');
    }
}

function showSection(section, event) {
    if (event) event.preventDefault();
    // Retire la classe active de tous les liens du menu
    document.querySelectorAll('.sidebar .nav-link').forEach(link => link.classList.remove('active'));
    // Ajoute la classe active au lien cliqué
    if (event && event.currentTarget) event.currentTarget.classList.add('active');
    // Cache toutes les sections
    document.querySelectorAll('.section').forEach(sec => {
        sec.classList.remove('active');
        sec.style.display = 'none';
        sec.style.visibility = 'hidden';
    });
    // Affiche la section demandée
    const target = document.getElementById('section-' + section);
    if (target) {
        target.classList.add('active');
        target.style.display = 'block';
        target.style.visibility = 'visible';
    }

    // Affichage dynamique selon la section
    if (section === 'info') {
        updateProjectInfo(projets[selectedProjetIndex]);
        // Vérification après rendu
        setTimeout(() => {
            const infoSection = document.getElementById('section-info');
            if (infoSection && infoSection.innerText.trim() === '') {
                infoSection.innerHTML = '<div class="alert alert-danger mt-3">Aucune information projet à afficher.</div>';
            }
        }, 100);
    } else if (section === 'suivi') {
        updateSuiviExecution(projets[selectedProjetIndex]);
    } else if (section === 'detail') {
        updateSuiviDetaille(projets[selectedProjetIndex]);
    } else if (section === 'reception') {
        updateReceptionSection(projets[selectedProjetIndex]);
    } else if (section === 'synthese') {
        updateSyntheseSection();
    }
}

function showAlert(msg, type) {
    let alert = document.getElementById('alert');
    if (!alert) {
        alert = document.createElement('div');
        alert.id = 'alert';
        alert.className = 'alert position-fixed top-0 end-0 m-4 d-flex align-items-center';
        document.body.appendChild(alert);
    }
    alert.className = 'alert alert-' + type + ' position-fixed top-0 end-0 m-4 d-flex align-items-center';
    alert.innerHTML = (type === 'success' ? '<i class="bi bi-check-circle-fill me-2"></i>' : '<i class="bi bi-exclamation-triangle-fill me-2"></i>') + msg;
    alert.style.display = 'block';
    setTimeout(() => { alert.style.display = 'none'; }, 2500);
}

function validateProjetForm() {
    // Tous les champs sont maintenant optionnels
    // Aucune validation obligatoire n'est requise
    return true;
}

function refreshUI(newProjets, newIndex = 0) {
    projets = newProjets;
    selectedProjetIndex = newIndex;
    renderProjetSelector();
    renderSections();
}

function fetchProjetsAndUpdateUI(selectIdx = 0) {
    fetch('/api/projets')
        .then(res => res.json())
        .then(data => refreshUI(data, selectIdx));
}

function connectWS() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function () {
        stompClient.subscribe('/topic/projets', function (message) {
            fetchProjetsAndUpdateUI(selectedProjetIndex);
        });
    });
}

// --- Persistance de la sélection du projet ---
function restoreSelectedProjet() {
  const savedProjetId = localStorage.getItem('selectedProjetId');
  if (savedProjetId && projets && projets.length > 0) {
    const idx = projets.findIndex(p => p.id == savedProjetId);
    if (idx !== -1) {
      selectedProjetIndex = idx;
      selectedProjet = projets[idx];
      document.getElementById('projetSelect').value = idx;
      renderSections();
      updateSynthese(selectedProjet);
      return true;
    }
  }
  // Si aucun projet sauvegardé ou non trouvé, sélectionne le premier
  if (projets && projets.length > 0) {
    selectedProjetIndex = 0;
    selectedProjet = projets[0];
    document.getElementById('projetSelect').value = 0;
    renderSections();
    updateSynthese(selectedProjet);
  }
  return false;
}

document.addEventListener('DOMContentLoaded', function() {
  renderProjetSelector();
  restoreSelectedProjet();
  connectWS();
});

if (document.getElementById('projetSelect')) {
  document.getElementById('projetSelect').onchange = function() {
    selectedProjetIndex = parseInt(this.value);
    selectedProjet = projets[selectedProjetIndex];
    if (selectedProjet && selectedProjet.id) {
      localStorage.setItem('selectedProjetId', selectedProjet.id);
    }
    renderSections();
    updateSynthese(selectedProjet);
  };
}
// --- Fin persistance sélection projet ---

// Actions CRUD
const actions = document.getElementById('actionsProjet');
const btnAddPieceJointe = document.getElementById('btnAddPieceJointe');
const btnAddProjet = document.getElementById('btnAddProjet');
const btnEditProjet = document.getElementById('btnEditProjet');
const btnDeleteProjet = document.getElementById('btnDeleteProjet');
if (userRole !== 'ADMIN' && userRole !== 'SUPERVISEUR') {
    actions.style.display = 'none';
    if (btnAddPieceJointe) btnAddPieceJointe.style.display = 'none';
} else {
    actions.style.display = 'flex';
    if (btnAddPieceJointe) btnAddPieceJointe.style.display = 'inline-block';
}
if (btnAddProjet) {
  btnAddProjet.onclick = () => {
      if (userRole === 'ADMIN' || userRole === 'SUPERVISEUR') {
          document.getElementById('projetForm').reset();
          document.getElementById('projetId').value = '';
          const modal = new bootstrap.Modal(document.getElementById('projetModal'));
          modal.show();
      }
  };
}
if (btnEditProjet) {
  btnEditProjet.onclick = () => {
      if (userRole === 'ADMIN' || userRole === 'SUPERVISEUR') {
          const projet = projets[selectedProjetIndex];
          console.log('Projet à modifier:', projet);
          if (!projet) {
              showAlert('Aucun projet sélectionné', 'danger');
              return;
          }
          document.getElementById('projetId').value = projet.id || '';
          document.getElementById('numeroProjet').value = projet.numeroProjet || '';
          document.getElementById('client').value = projet.client || '';
          document.getElementById('designation').value = projet.designation || '';
          document.getElementById('typeProjet').value = projet.typeProjet || '';
          document.getElementById('responsableInterne').value = projet.responsableInterne || '';
          document.getElementById('responsableExterne').value = projet.responsableExterne || '';
          document.getElementById('dureeContractuelle').value = projet.dureeContractuelle || '';
          document.getElementById('montantContratTTC').value = projet.montantContratTTC || '';
          document.getElementById('montantAvenant').value = projet.montantAvenant || '';

          document.getElementById('dateDebut').value = projet.dateDebut || '';
          document.getElementById('dateFinEffective').value = projet.dateFinEffective || '';
          document.getElementById('pourcentageAvancement').value = projet.avancement || '';
          document.getElementById('statutExecution').value = projet.statutExecution || '';
          document.getElementById('montantCumul').value = projet.montantCumul || '';
          document.getElementById('montantEncaisse').value = projet.montantEncaisse || '';
          document.getElementById('soldeRestant').value = projet.soldeRestant || '';
          document.getElementById('statutFacturation').value = projet.statutFacturation || '';
          document.getElementById('remarques').value = projet.remarques || '';
          
          // Remplir les nouveaux champs de suivi d'exécution détaillé
          document.getElementById('phase').value = projet.phase || '';
          document.getElementById('zone').value = projet.zone || '';
          document.getElementById('quantiteInstallee').value = projet.quantiteInstallee || '';
          document.getElementById('remarquesExecution').value = projet.remarquesExecution || '';
          
          // Remplir les nouveaux champs de suivi règlement détaillé
          document.getElementById('nAttachment').value = projet.nAttachment || '';
          document.getElementById('dateAttachement').value = projet.dateAttachement || '';
          document.getElementById('dateFacture').value = projet.dateFacture || '';
          document.getElementById('datePaiement').value = projet.datePaiement || '';
          document.getElementById('modeReglement').value = projet.modeReglement || '';
          document.getElementById('remarqueReglement').value = projet.remarqueReglement || '';
          document.getElementById('solde').value = projet.solde || '';
          const modal = new bootstrap.Modal(document.getElementById('projetModal'));
          modal.show();
      }
  };
}
if (btnDeleteProjet) {
  btnDeleteProjet.onclick = () => {
      if (userRole === 'ADMIN' || userRole === 'SUPERVISEUR') {
          const projet = projets[selectedProjetIndex];
          console.log('Projet sélectionné:', projet);
          if (!projet || !projet.id) {
              showAlert('Projet sans ID - impossible de supprimer', 'danger');
              return;
          }
          if (confirm('Supprimer ce projet ?')) {
              fetch(`/api/projets/${projet.id}`, { method: 'DELETE' })
                  .then(res => {
                      if (res.ok) {
                          showAlert('Projet supprimé avec succès !', 'success');
                          // Rafraîchir les données du projet
                          fetch('/api/projets')
                            .then(res => res.json())
                            .then(data => {
                              projets = data;
                              // Si le projet supprimé était le dernier, sélectionner le nouveau dernier
                              if (selectedProjetIndex >= projets.length) {
                                  selectedProjetIndex = Math.max(0, projets.length - 1);
                              }
                              renderProjetSelector();
                              renderSections();
                            });
                      } else {
                          showAlert('Erreur lors de la suppression.', 'danger');
                      }
                  }).catch(error => {
                      console.error('Erreur:', error);
                      showAlert('Erreur lors de la suppression.', 'danger');
                  });
          }
      }
  };
}
if (btnAddPieceJointe) {
  btnAddPieceJointe.onclick = () => {
      if (userRole === 'ADMIN' || userRole === 'SUPERVISEUR') {
          const projet = projets[selectedProjetIndex];
          if (!projet || !projet.id) {
              showAlert('Aucun projet sélectionné', 'danger');
              return;
          }
          document.getElementById('pieceJointeProjetId').value = projet.id;
          document.getElementById('pieceJointeForm').reset();
          // Remettre toutes les options
          const select = document.getElementById('typePieceJointe');
          select.innerHTML = `
            <option value="">Sélectionner un type</option>
            <option value="pvReceptionProvisoire">PV de réception provisoire</option>
            <option value="pvReceptionDefinitif">PV de réception définitive</option>
            <option value="attestationReference">Attestation de référence</option>
          `;
          const modal = new bootstrap.Modal(document.getElementById('pieceJointeModal'));
          modal.show();
          setTimeout(attachSavePieceJointeHandler, 0);
      }
  };
}

// Gestion des pièces jointes - SUPPRIMÉ car déjà géré plus haut avec protection

// Handler unifié pour l'enregistrement de pièce jointe (ajout/modification)
function attachSavePieceJointeHandler() {
    const btnSave = document.getElementById('btnSavePieceJointe');
    if (btnSave) {
        btnSave.onclick = function() {
            if (userRole === 'EMPLOYE') {
                showAlert('Vous n\'avez pas les permissions pour effectuer cette action.', 'warning');
                return;
            }
            const formData = new FormData();
            const projetId = document.getElementById('pieceJointeProjetId').value;
            let type = document.getElementById('typePieceJointe').value;
            // Correction : si le select est désactivé, prendre la valeur du champ hidden
            if (document.getElementById('typePieceJointe').disabled) {
                const hiddenType = document.getElementById('hiddenTypePieceJointe');
                if (hiddenType && hiddenType.value) {
                    type = hiddenType.value;
                }
            }
            const fichier = document.getElementById('fichierPieceJointe').files[0];
            const description = document.getElementById('descriptionPieceJointe').value;
            
            formData.append('projetId', projetId);
            formData.append('type', type);
            formData.append('description', description);
            
            // Si modification et pas de nouveau fichier, envoyer l'ancien nom de fichier
            if (fichier) {
                formData.append('fichier', fichier);
            } else {
                // On récupère le nom du fichier courant pour ce type
                const projet = projets[selectedProjetIndex];
                let nomFichier = '';
                if (projet && projet.piecesJointes && projet.piecesJointes[type] && projet.piecesJointes[type].nomFichier) {
                    nomFichier = projet.piecesJointes[type].nomFichier;
                }
                if (nomFichier) {
                    formData.append('nomFichier', nomFichier);
                }
            }
            
            fetch('/api/pieces-jointes', {
                method: 'POST',
                body: formData
            }).then(res => {
                if (res.ok) {
                    showAlert('Pièce jointe enregistrée avec succès !', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('pieceJointeModal')).hide();
                    fetch('/api/projets')
                      .then(res => res.json())
                      .then(data => {
                        projets = data;
                        const idx = projets.findIndex(p => p.id == projetId);
                        selectedProjetIndex = idx !== -1 ? idx : 0;
                        renderProjetSelector();
                        renderSections();
                      });
                } else {
                    res.text().then(msg => showAlert('Erreur lors de l\'enregistrement : ' + msg, 'danger'));
                }
            }).catch(error => {
                console.error('Erreur:', error);
                showAlert('Erreur lors de l\'enregistrement.', 'danger');
            });
        };
    }
}

// Correction suppression : afficher l'erreur du backend si besoin
function supprimerPieceJointe(type) {
    if (userRole === 'EMPLOYE') {
        showAlert('Vous n\'avez pas les permissions pour effectuer cette action.', 'warning');
        return;
    }
    if (!confirm("Voulez-vous vraiment supprimer cette pièce jointe ?")) return;
    const projet = projets[selectedProjetIndex];
    if (!projet || !projet.id) {
        showAlert('Aucun projet sélectionné', 'danger');
        return;
    }
    fetch(`/api/pieces-jointes/${projet.id}/${type}`, {
        method: 'DELETE'
    }).then(res => {
        if (res.ok) {
            showAlert('Pièce jointe supprimée avec succès !', 'success');
            fetch('/api/projets')
                .then(res => res.json())
                .then(data => {
                    projets = data;
                    renderProjetSelector();
                    renderSections();
                });
        } else {
            res.text().then(msg => showAlert('Erreur lors de la suppression : ' + msg, 'danger'));
        }
    }).catch(error => {
        showAlert('Erreur lors de la suppression.', 'danger');
    });
}

// Dans modifierPieceJointe(type), stocker le type courant dans data-current-type
function modifierPieceJointe(type) {
    if (userRole === 'EMPLOYE') {
        showAlert('Vous n\'avez pas les permissions pour effectuer cette action.', 'warning');
        return;
    }
    const projet = projets[selectedProjetIndex];
    if (!projet || !projet.id) {
        showAlert('Aucun projet sélectionné', 'danger');
        return;
    }
    document.getElementById('pieceJointeProjetId').value = projet.id;
    document.getElementById('pieceJointeForm').reset();
    document.getElementById('typePieceJointe').value = type;
    document.getElementById('typePieceJointe').disabled = true;
    document.getElementById('typePieceJointe').setAttribute('data-current-type', type);
    const modal = new bootstrap.Modal(document.getElementById('pieceJointeModal'));
    modal.show();
    setTimeout(attachSavePieceJointeHandler, 0);
}

// Quand tu ouvres la modale en mode ajout classique, réactive le select
function ouvrirAjoutPieceJointe() {
    document.getElementById('pieceJointeForm').reset();
    document.getElementById('typePieceJointe').disabled = false;
    const modal = new bootstrap.Modal(document.getElementById('pieceJointeModal'));
    modal.show();
}

// Réinitialise le select après fermeture de la modale
const pieceJointeModal = document.getElementById('pieceJointeModal');
if (pieceJointeModal) {
    pieceJointeModal.addEventListener('hidden.bs.modal', function () {
        document.getElementById('typePieceJointe').disabled = false;
    });
}



// Fonction pour sauvegarder le suivi règlement détaillé
function sauvegarderSuiviReglement() {
    if (userRole === 'EMPLOYE') {
        showAlert('Vous n\'avez pas les permissions pour effectuer cette action.', 'warning');
        return;
    }
    
    const projet = projets[selectedProjetIndex];
    if (!projet || !projet.id) {
        showAlert('Aucun projet sélectionné', 'danger');
        return;
    }
    
    const formData = {
        id: projet.id,
        nAttachment: document.getElementById('nAttachment').value,
        dateAttachement: document.getElementById('dateAttachement').value,
        dateFacture: document.getElementById('dateFacture').value,
        datePaiement: document.getElementById('datePaiement').value,
        modeReglement: document.getElementById('modeReglement').value,
        remarqueReglement: document.getElementById('remarqueReglement').value
    };
    
    fetch(`/api/projets/${projet.id}/suivi-reglement`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    }).then(res => {
        if (res.ok) {
            showAlert('Suivi règlement sauvegardé avec succès !', 'success');
            // Rafraîchir les données du projet
            fetch('/api/projets')
                .then(res => res.json())
                .then(data => {
                    projets = data;
                    const idx = projets.findIndex(p => p.id == projet.id);
                    selectedProjetIndex = idx !== -1 ? idx : 0;
                    renderProjetSelector();
                    renderSections();
                });
        } else {
            res.text().then(msg => showAlert('Erreur lors de la sauvegarde : ' + msg, 'danger'));
        }
    }).catch(error => {
        console.error('Erreur:', error);
        showAlert('Erreur lors de la sauvegarde.', 'danger');
    });
}

// Initialisation du handler pour le bouton d'enregistrement de pièce jointe
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded - Initialisation des gestionnaires...');
    if (document.getElementById('btnSavePieceJointe')) {
        attachSavePieceJointeHandler();
    }
    
    // Gestionnaire spécifique pour le bouton Enregistrer du projet
    const btnSaveProjet = document.getElementById('btnSaveProjet');
    if (btnSaveProjet) {
        console.log('Bouton Enregistrer projet trouvé, ajout du gestionnaire...');
        btnSaveProjet.onclick = function(e) {
            e.preventDefault();
            console.log('Clic sur Enregistrer projet détecté !');
            
            // Déclencher la soumission du formulaire
            const projetForm = document.getElementById('projetForm');
            if (projetForm) {
                console.log('Soumission du formulaire projet...');
                projetForm.dispatchEvent(new Event('submit'));
            } else {
                console.error('Formulaire projet non trouvé !');
            }
        };
    } else {
        console.error('Bouton Enregistrer projet non trouvé !');
    }
});

// Gestionnaire d'événements pour le formulaire de projet
const projetForm = document.getElementById('projetForm');
if (projetForm) {
    projetForm.onsubmit = function(e) {
        e.preventDefault();
        console.log('Submit intercepté !');
        if (userRole === 'EMPLOYE') {
            showAlert('Vous n\'avez pas les permissions pour effectuer cette action.', 'warning');
            return;
        }
        if (!validateProjetForm()) return;
        const id = document.getElementById('projetId').value;
        // Récupération des nouveaux champs avec vérification
        const phase = document.getElementById('phase').value;
        const zone = document.getElementById('zone').value;
        const quantiteInstallee = document.getElementById('quantiteInstallee').value;
        const remarquesExecution = document.getElementById('remarquesExecution').value;
        
        // Récupération des nouveaux champs règlement
        const nAttachment = document.getElementById('nAttachment').value;
        const dateAttachement = document.getElementById('dateAttachement').value;
        const dateFacture = document.getElementById('dateFacture').value;
        const datePaiement = document.getElementById('datePaiement').value;
        const modeReglement = document.getElementById('modeReglement').value;
        const remarqueReglement = document.getElementById('remarqueReglement').value;
        
        console.log('Nouveaux champs récupérés:', {
            phase: phase,
            zone: zone,
            quantiteInstallee: quantiteInstallee,
            remarquesExecution: remarquesExecution,
            nAttachment: nAttachment,
            dateAttachement: dateAttachement,
            dateFacture: dateFacture,
            datePaiement: datePaiement,
            modeReglement: modeReglement,
            remarqueReglement: remarqueReglement
        });
        
        const projet = {
            numeroProjet: document.getElementById('numeroProjet').value,
            client: document.getElementById('client').value,
            designation: document.getElementById('designation').value,
            typeProjet: document.getElementById('typeProjet').value,
            responsableInterne: document.getElementById('responsableInterne').value,
            responsableExterne: document.getElementById('responsableExterne').value,
            dureeContractuelle: document.getElementById('dureeContractuelle').value,
            montantContratTTC: document.getElementById('montantContratTTC').value,
            montantAvenant: document.getElementById('montantAvenant').value,

            dateDebut: document.getElementById('dateDebut').value,
            dateFinEffective: document.getElementById('dateFinEffective').value,
            avancement: document.getElementById('pourcentageAvancement').value,
            statutExecution: document.getElementById('statutExecution').value,
            montantCumul: document.getElementById('montantCumul').value,
            montantEncaisse: document.getElementById('montantEncaisse').value,
            soldeRestant: document.getElementById('soldeRestant').value,
            statutFacturation: document.getElementById('statutFacturation').value,
            remarques: document.getElementById('remarques').value,
            
            // Nouveaux champs de suivi d'exécution détaillé
            phase: phase,
            zone: zone,
            quantiteInstallee: quantiteInstallee,
            remarquesExecution: remarquesExecution,
            
            // Nouveaux champs de suivi règlement détaillé
            nAttachment: document.getElementById('nAttachment').value,
            dateAttachement: document.getElementById('dateAttachement').value,
            dateFacture: document.getElementById('dateFacture').value,
            datePaiement: document.getElementById('datePaiement').value,
            modeReglement: document.getElementById('modeReglement').value,
            remarqueReglement: document.getElementById('remarqueReglement').value,
            solde: document.getElementById('solde').value
        };
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/projets/${id}` : '/api/projets';
        console.log('Envoi de la requête:', method, url);
        console.log('Données du projet:', projet);
        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(projet)
        }).then(res => {
            console.log('Réponse du serveur:', res.status, res.statusText);
            if (res.ok) {
                console.log('Projet enregistré avec succès !');
                showAlert('Projet enregistré avec succès !', 'success');
                bootstrap.Modal.getInstance(document.getElementById('projetModal')).hide();
                // Rafraîchir les données du projet
                fetch('/api/projets')
                  .then(res => res.json())
                  .then(data => {
                    console.log('Rafraîchissement UI après enregistrement, projets:', data);
                    projets = data;
                    // Si c'est un nouveau projet, sélectionner le dernier
                    if (!id) {
                        selectedProjetIndex = projets.length - 1;
                    }
                    renderProjetSelector();
                    renderSections();
                  });
            } else {
                console.log('Erreur lors de l\'enregistrement !');
                // Récupérer le message d'erreur détaillé
                res.text().then(errorMsg => {
                    console.error('Erreur serveur:', errorMsg);
                    showAlert('Erreur lors de l\'enregistrement: ' + errorMsg, 'danger');
                }).catch(() => {
                    showAlert('Erreur lors de l\'enregistrement (code: ' + res.status + ')', 'danger');
                });
            }
        }).catch(error => {
            console.error('Erreur réseau:', error);
            showAlert('Erreur de connexion lors de l\'enregistrement.', 'danger');
        });
    };
}

// Fonction pour ajouter une pièce jointe pour le suivi règlement détaillé
function ajouterPieceJointeSuiviReglement() {
    if (userRole === 'EMPLOYE') {
        showAlert('Vous n\'avez pas les permissions pour effectuer cette action.', 'warning');
        return;
    }
    const projet = projets[selectedProjetIndex];
    if (!projet || !projet.id) {
        showAlert('Aucun projet sélectionné', 'danger');
        return;
    }
    document.getElementById('pieceJointeProjetId').value = projet.id;
    document.getElementById('pieceJointeForm').reset();
    // Définir automatiquement le type pour suivi règlement détaillé
    const select = document.getElementById('typePieceJointe');
    select.innerHTML = `
        <option value=\"suivi_reglement_detaille\" selected>Suivi règlement détaillé</option>
    `;
    select.disabled = true;
    // Ajoute ou met à jour un champ hidden pour garantir l'envoi du type
    let hiddenType = document.getElementById('hiddenTypePieceJointe');
    if (!hiddenType) {
        hiddenType = document.createElement('input');
        hiddenType.type = 'hidden';
        hiddenType.id = 'hiddenTypePieceJointe';
        hiddenType.name = 'hiddenTypePieceJointe';
        select.parentNode.appendChild(hiddenType);
    }
    hiddenType.value = 'suivi_reglement_detaille';
    const modal = new bootstrap.Modal(document.getElementById('pieceJointeModal'));
    modal.show();
    setTimeout(attachSavePieceJointeHandler, 0);
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('btnAddPieceJointeDetail');
  if (btn && (userRole === 'ADMIN' || userRole === 'SUPERVISEUR')) {
    btn.style.display = 'inline-block';
    btn.onclick = function() {
      const projet = projets[selectedProjetIndex];
      if (!projet || !projet.id) {
        showAlert('Aucun projet sélectionné', 'danger');
        return;
      }
      document.getElementById('pieceJointeProjetId').value = projet.id;
      document.getElementById('pieceJointeForm').reset();
      // Limite les options du select pour Suivi détaillé
      const select = document.getElementById('typePieceJointe');
      select.innerHTML = `
        <option value="">Sélectionner un type</option>
        <option value="suivi_execution_detaille">Suivi exécution détaillée</option>
        <option value="suivi_reglement_detaille">Suivi règlement détaillé</option>
      `;
      const modal = new bootstrap.Modal(document.getElementById('pieceJointeModal'));
      modal.show();
      setTimeout(attachSavePieceJointeHandler, 0);
    };
  }
});
</script>
</body>
</html> 